#!/usr/bin/env zsh

# Save the current tmux session name
ORIGINAL_SESSION_NAME=$(tmux display-message -p '#S')

# Rename the current tmux session to indicate updating
tmux rename-session -t "$ORIGINAL_SESSION_NAME" "ğŸŒ Updating"

# Display styled text with `gum`
gum style \
    --foreground 12 --border-foreground 12 --border double \
    --align center --width 60 --margin "1 0" --padding "1 0" \
    'â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  
â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•'

NOW=$(date +"%Y-%m-%d-%H-%M-%S")
echo -e "$NOW\n" >> /tmp/u-$NOW.txt

# Update TPM plugins
gum spin --spinner globe --title "ğŸªŸ tpm plugins updating..." --show-output -- ~/.config/tmux/plugins/tpm/bin/update_plugins all >> /tmp/u-$NOW.txt
echo "\n" >> /tmp/u-$NOW.txt
echo "âœ… ğŸªŸ tpm plugins updated"

# Sync lazy.nvim
gum spin --spinner globe --title "ğŸ’¤ lazy.nvim syncing..." -- nvim --headless "+Lazy! sync" +qa
echo "\n" >> /tmp/u-$NOW.txt
echo "âœ… ğŸ’¤ lazy.nvim synced"

# Update nvim-treesitter
gum spin --spinner globe --title "ğŸŒ³ nvim-treesitter updating" -- nvim --headless -c TSUpdate +qa
echo "\n" >> /tmp/u-$NOW.txt
echo "âœ… ğŸŒ³ nvim-treesitter updated"

# Update Homebrew
gum spin --spinner globe --title "ğŸ» brew updating" --show-output -- brew update >> /tmp/u-$NOW.txt
echo "\n" >> /tmp/u-$NOW.txt
echo "âœ… ğŸ» brew updated"

OUTDATED=$(brew outdated)
echo $OUTDATED >> /tmp/u-$NOW.txt

if [[ -n "$OUTDATED" ]]; then
    gum spin --spinner globe --title "ğŸ» brew upgrading" --show-output -- brew upgrade >> /tmp/u-$NOW.txt
    echo "\n" >> /tmp/u-$NOW.txt
    echo "âœ… ğŸ» brew upgraded"

    gum spin --spinner globe --title "ğŸ» brew cleaning up" --show-output -- brew cleanup --prune=all >> /tmp/u-$NOW.txt
    echo "\n" >> /tmp/u-$NOW.txt
    echo "âœ… ğŸ» brew cleaned up"
else
    echo "No outdated brew packages" >> /tmp/u-$NOW.txt
fi

gum spin --spinner globe --title "ğŸ» brew doctoring" --show-output -- brew doctor >> /tmp/u-$NOW.txt
echo "\n" >> /tmp/u-$NOW.txt
echo "âœ… ğŸ» brew doctored"

# Update Mac App Store applications
gum spin --spinner globe --title "ğŸ mas upgrading" --show-output -- mas upgrade >> /tmp/u-$NOW.txt
echo "\n" >> /tmp/u-$NOW.txt
echo "âœ… ğŸ mas upgraded"

echo "âœ… ğŸ§¾ logged to /tmp/u-$NOW.txt"

# Ask if the user wants to view the log
if gum confirm "Do you want to view the update log?"; then
    man /tmp/u-$NOW.txt
fi

# Restore the original session name
tmux rename-session -t "ğŸŒ Updating" "$ORIGINAL_SESSION_NAME"
