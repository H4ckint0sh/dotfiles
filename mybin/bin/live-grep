#!/usr/bin/env bash

# Colors
ORANGE='#ff9e64'
FOREGROUND='#a9b1d6'

# Key bindings
FILE_PATH='ctrl-y:execute(echo -n {1}:{2} | pbcopy)'
KEYS="$FILE_PATH"

# Optional flag for execution and exit behavior
if [[ $1 == '--exit-on-execution' ]]; then
  KEYS="$KEYS+abort"
  shift # remove the flag from the arguments so it's not passed to the `rg` command
fi

SELECTED_MATCHES=$'\n' readarray -t selected_matches < <(
  rg --color=always --line-number --no-heading --smart-case "${*:-}" |
    fzf --ansi \
      --border none \
      --color "hl+:$ORANGE:reverse,hl:$FOREGROUND:reverse" \
      --delimiter ':' \
      --height '100%' \
      --multi \
      --print-query --exit-0 \
      --preview 'bat {1} --highlight-line {2}' \
      --preview-window 'right,+{2}+3/3,~3' \
      --scrollbar '▍' \
      --bind "$KEYS"
)

# Print the file path and line number of each match
for LINE in "${SELECTED_MATCHES[@]:1}"; do
  FILE=$(echo "$LINE" | cut -d: -f1)
  LINE_NUMBER=$(echo "$LINE" | cut -d: -f2)
  echo "$FILE:$LINE_NUMBER"
done